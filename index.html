<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SprÃ¡va hudebnÃ­ch Å¾Ã¡kÅ¯</title>
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#22c55e; --accent2:#3b82f6;
      --danger:#ef4444; --warning:#eab308; --surface:#1f2937; --border:#374151;
    }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 16px 0; font-size: 26px; font-weight: 700; }
    h2 { font-size: 20px; margin: 0 0 12px 0; }
    
    /* Navigation */
    .nav { display:flex; gap:12px; align-items:center; margin-bottom: 20px; flex-wrap: wrap; }
    .nav-btn { padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); text-decoration:none; cursor:pointer; transition:all 0.2s; }
    .nav-btn:hover { background:var(--surface); }
    .nav-btn.active { background:var(--accent); color:white; }
    
    /* Controls */
    .controls { display:flex; gap:12px; flex-wrap: wrap; margin-bottom: 16px; }
    .select { background:var(--card); color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:8px; min-width:160px; }
    .btn { padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:500; transition:all 0.2s; }
    .btn-primary { background:var(--accent); color:white; }
    .btn-primary:hover { opacity:0.9; transform:translateY(-1px); }
    .btn-danger { background:var(--danger); color:white; }
    .btn-secondary { background:var(--surface); color:var(--text); border:1px solid var(--border); }
    
    /* Stats */
    .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:14px; margin: 12px 0 20px; }
    .stat { background:linear-gradient(180deg,var(--card), #0b1220); border:1px solid var(--border); border-radius:12px; padding:16px; text-align:center; }
    .stat .num { font-size:24px; font-weight:800; margin-top:6px; color:#a5b4fc; }
    .stat .label { font-size:12px; color:var(--muted); text-transform:uppercase; }
    
    /* Grid */
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; }
    .card { background:linear-gradient(180deg,var(--card), #0b1220); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); transition:transform 0.2s; cursor:pointer; }
    .card:hover { transform:translateY(-2px); }
    .row { display:flex; gap:12px; align-items:center; }
    .avatar { width:54px; height:54px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:18px; overflow:hidden; }
    .avatar img { width:100%; height:100%; object-fit:cover; }
    .name { font-weight:700; font-size:18px; }
    .muted { color: var(--muted); font-size: 13px; margin-top:4px; }
    .badges { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .badge { font-size:12px; padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:var(--card); }
    .mot-high { color:var(--accent); }
    .mot-mid { color:var(--warning); }
    .mot-low { color:var(--danger); }
    
    /* Detail View */
    .detail-view { display:none; }
    .detail-header { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:20px; }
    .detail-avatar { width:80px; height:80px; font-size:28px; }
    .detail-info h2 { margin-bottom:8px; }
    .detail-meta { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-top:16px; }
    .meta-item { background:var(--surface); padding:12px; border-radius:8px; }
    .meta-label { font-size:12px; color:var(--muted); text-transform:uppercase; }
    .meta-value { font-weight:600; margin-top:4px; }
    
    /* Tasks & Awards */
    .section { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:20px; }
    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .task-item, .award-item { background:var(--surface); border-radius:8px; padding:12px; margin-bottom:8px; }
    .task-header { display:flex; justify-content:space-between; align-items:start; margin-bottom:8px; }
    .task-title { font-weight:600; }
    .task-points { background:var(--accent); color:white; padding:2px 8px; border-radius:12px; font-size:12px; }
    .task-status { display:inline-block; padding:4px 8px; border-radius:6px; background:var(--border); font-size:12px; margin-top:8px; }
    .task-date { font-size:11px; color:var(--muted); margin-top:4px; }
    
    /* Modal */
    .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:1000; padding:20px; }
    .modal.show { display:flex; }
    .modal-content { background:var(--card); border-radius:16px; padding:24px; width:100%; max-width:500px; max-height:80vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .modal-close { background:none; border:none; color:var(--muted); font-size:24px; cursor:pointer; }
    .form-group { margin-bottom:16px; }
    .form-label { display:block; margin-bottom:4px; font-weight:500; }
    .form-input { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text); }
    .form-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:20px; }
    
    /* Charts */
    .chart-container { background:var(--surface); border-radius:8px; padding:16px; margin:12px 0; position:relative; height:200px; }
    .chart-bar { background:var(--accent); border-radius:4px; transition:all 0.3s; }
    .chart-label { font-size:12px; color:var(--muted); text-align:center; margin-top:8px; }
    
    /* Progress Ring */
    .progress-ring { width:60px; height:60px; }
    .progress-ring circle { transition:stroke-dasharray 0.35s; transform:rotate(-90deg); transform-origin:50% 50%; }
    
    /* Mobile Responsive */
    @media (max-width: 768px) { 
      .container { padding:12px; }
      .stats { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .detail-meta { grid-template-columns: 1fr; }
      .nav { flex-direction:column; align-items:stretch; }
      .nav-btn { text-align:center; }
      .controls { flex-direction:column; }
      .select { min-width:100%; }
      .modal-content { margin:0; width:100%; max-width:none; border-radius:16px 16px 0 0; }
      .form-actions { flex-direction:column; }
      h1 { font-size:22px; }
    }
    @media (max-width: 480px) {
      .container { padding:8px; }
      .card { padding:12px; }
      .detail-header { padding:16px; }
      .section { padding:16px; }
    }
    
    /* Animations */
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    
    /* Hidden utility */
    .hidden { display: none !important; }
    
    /* Loading */
    .loading { text-align:center; padding:40px; color:var(--muted); }
    .spinner { width:40px; height:40px; border:4px solid var(--border); border-top:4px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <h1>ğŸµ SprÃ¡va hudebnÃ­ch Å¾Ã¡kÅ¯</h1>
      <button class="nav-btn active" data-view="dashboard">ğŸ“Š Dashboard</button>
      <button class="nav-btn" data-view="statistics">ğŸ“ˆ Statistiky</button>
      <button class="nav-btn" onclick="location.reload()">ğŸ”„ Obnovit</button>
    </div>

    <div id="dashboard-view" class="dashboard-view">
      <div class="controls">
        <select class="select" id="fInstrument">
          <option value="">VÅ¡echny nÃ¡stroje</option>
          <option value="kytara">Kytara</option>
          <option value="klarinet">Klarinet</option>
          <option value="zobcovÃ¡ flÃ©tna">ZobcovÃ¡ flÃ©tna</option>
          <option value="saxofon">Saxofon</option>
        </select>
        <select class="select" id="fGrade">
          <option value="">VÅ¡echny roÄnÃ­ky</option>
          <option value="1">1. roÄnÃ­k</option>
          <option value="2">2. roÄnÃ­k</option>
          <option value="3">3. roÄnÃ­k</option>
          <option value="4">4. roÄnÃ­k</option>
        </select>
        <select class="select" id="fMot">
          <option value="">VÅ¡echny stavy</option>
          <option value="high">VysokÃ¡ motivace</option>
          <option value="mid">StÅ™ednÃ­ motivace</option>
          <option value="low">Krize motivace</option>
        </select>
        <button class="btn btn-primary" onclick="showAddTaskModal()">â• PÅ™idat Ãºkol</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="label">Celkem Å¾Ã¡kÅ¯</div>
          <div class="num" id="totalStudents">0</div>
        </div>
        <div class="stat">
          <div class="label">AktivnÃ­ch ÃºkolÅ¯</div>
          <div class="num" id="activeTasks">0</div>
        </div>
        <div class="stat">
          <div class="label">DokonÄenÃ½ch ÃºkolÅ¯</div>
          <div class="num" id="completedTasks">0</div>
        </div>
        <div class="stat">
          <div class="label">UdÄ›lenÃ½ch ocenÄ›nÃ­</div>
          <div class="num" id="totalAwards">0</div>
        </div>
      </div>

      <div id="grid" class="grid"></div>
    </div>

    <div id="statistics-view" class="statistics-view" style="display:none;">
      <div class="stats">
        <div class="stat">
          <div class="label">PrÅ¯mÄ›rnÃ© body</div>
          <div class="num" id="avgPoints">0</div>
        </div>
        <div class="stat">
          <div class="label">NejaktivnÄ›jÅ¡Ã­ nÃ¡stroj</div>
          <div class="num" id="topInstrument">-</div>
        </div>
        <div class="stat">
          <div class="label">ÃšspÄ›Å¡nost</div>
          <div class="num" id="successRate">0%</div>
        </div>
      </div>
      
      <div class="section">
        <h2>ğŸ“Š RozdÄ›lenÃ­ podle nÃ¡strojÅ¯</h2>
        <div id="instrumentChart" class="chart-container"></div>
      </div>
      
      <div class="section">
        <h2>ğŸ“ˆ Pokrok podle roÄnÃ­kÅ¯</h2>
        <div id="gradeChart" class="chart-container"></div>
      </div>
    </div>

    <div id="detail-view" class="detail-view">
      <button class="nav-btn" onclick="showDashboard()">â† ZpÄ›t na dashboard</button>
      
      <div class="detail-header">
        <div class="row">
          <div class="avatar detail-avatar" id="detailAvatar"></div>
          <div class="detail-info">
            <h2 id="detailName">JmÃ©no Å¾Ã¡ka</h2>
            <div class="muted" id="detailBasicInfo">NÃ¡stroj â€¢ RoÄnÃ­k â€¢ VÄ›k</div>
            <div class="detail-meta" id="detailMeta"></div>
          </div>
        </div>
      </div>

      <div id="student-only-sections" style="display: none;">
        <div class="section">
          <div class="section-header">
            <h2>ğŸ“ Ãškoly</h2>
            <button class="btn btn-primary" onclick="showAddTaskModal()">â• PÅ™idat Ãºkol</button>
          </div>
          <div id="detailTasks"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>ğŸ† OcenÄ›nÃ­</h2>
            <button class="btn btn-primary" onclick="showAddAwardModal()">â• PÅ™idat ocenÄ›nÃ­</button>
          </div>
          <div id="detailAwards"></div>
        </div>
      </div>

      <div id="admin-only-sections" style="display: none;">
        <div class="section">
          <h2>ğŸ“Š SkÃ³re</h2>
          <div class="stats">
            <div class="stat">
              <div class="label">CelkovÃ½ poÄet bodÅ¯</div>
              <div class="num" id="scorePoints">0</div>
            </div>
            <div class="stat">
              <div class="label">ProbÃ­hajÃ­cÃ­ skladby</div>
              <div class="num" id="scoreOngoingCompositions">0</div>
            </div>
            <div class="stat">
              <div class="label">DokonÄenÃ© skladby</div>
              <div class="num" id="scoreCompletedCompositions">0</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>ğŸµ Na Äem pracujeme</h2>
            <button class="btn btn-primary" onclick="showAddTaskModal()">â• PÅ™idat Ãºkol</button>
          </div>
          <div id="tasks-compositions"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>ğŸ“ PrÅ¯bÄ›h uÄenÃ­</h2>
          </div>
          <h3>CviÄenÃ­ na pÅ™Ã­Å¡tÄ›</h3>
          <div id="tasks-no-compositions"></div>
          <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
          <h3>PÅ™edchozÃ­ Ãºkoly</h3>
          <div id="tasks-completed"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>ğŸ† Moje ocenÄ›nÃ­</h2>
          </div>
          <div id="my-awards"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="addTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>â• PÅ™idat novÃ½ Ãºkol</h2>
        <button class="modal-close" onclick="hideModal('addTaskModal')">&times;</button>
      </div>
      <form id="addTaskForm">
        <div class="form-group">
          <label class="form-label">Å½Ã¡k</label>
          <select class="form-input" id="taskStudent" required>
            <option value="">Vyberte Å¾Ã¡ka...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">NÃ¡zev Ãºkolu</label>
          <input type="text" class="form-input" id="taskTitle" required placeholder="NapÅ™. ProcviÄit stupnice C dur">
        </div>
        <div class="form-group">
          <label class="form-label">Skladba</label>
          <input type="text" class="form-input" id="taskComposition" placeholder="NapÅ™. Bach - Inventio Ä. 1">
        </div>
        <div class="form-group">
          <label class="form-label">PoznÃ¡mka</label>
          <textarea class="form-input" id="taskNote" rows="3" placeholder="DodateÄnÃ© poznÃ¡mky k Ãºkolu..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Stav</label>
          <select class="form-input" id="taskStatus">
            <option value="â³ CviÄÃ­me">â³ CviÄÃ­me</option>
            <option value="ğŸš€ SkvÄ›lÃ½ pokrok!">ğŸš€ SkvÄ›lÃ½ pokrok!</option>
            <option value="âœ… ZvlÃ¡dnuto">âœ… ZvlÃ¡dnuto</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Body (1-10)</label>
          <input type="number" class="form-input" id="taskPoints" min="1" max="10" value="5">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="hideModal('addTaskModal')">ZruÅ¡it</button>
          <button type="submit" class="btn btn-primary">PÅ™idat Ãºkol</button>
        </div>
      </form>
    </div>
  </div>

  <div id="addAwardModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ† PÅ™idat ocenÄ›nÃ­</h2>
        <button class="modal-close" onclick="hideModal('addAwardModal')">&times;</button>
      </div>
      <form id="addAwardForm">
        <div class="form-group">
          <label class="form-label">Å½Ã¡k</label>
          <select class="form-input" id="awardStudent" required>
            <option value="">Vyberte Å¾Ã¡ka...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">NÃ¡zev ocenÄ›nÃ­</label>
          <input type="text" class="form-input" id="awardTitle" required placeholder="NapÅ™. RytmickÃ½ mistr">
        </div>
        <div class="form-group">
          <label class="form-label">Popis</label>
          <textarea class="form-input" id="awardDescription" rows="3" required placeholder="Za co Å¾Ã¡k ocenÄ›nÃ­ zÃ­skal..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">URL obrÃ¡zku (volitelnÃ©)</label>
          <input type="url" class="form-input" id="awardImageUrl" placeholder="https://imgur.com/...">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="hideModal('addAwardModal')">ZruÅ¡it</button>
          <button type="submit" class="btn btn-primary">PÅ™idat ocenÄ›nÃ­</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ZMÄšÅ‡TE TUTO URL NA VAÅ I NOVOU GOOGLE APPS SCRIPT URL!
    const CONFIG = {
      apiBaseUrl: "https://script.google.com/macros/s/AKfycbwvOOJ0K9gbtAhbSKccv7w_RULVAXiyevvmTVIHvtKNfFMnxF6Pb1UobbHkleA6-V-g0w/exec",
      timeoutMs: 8000
    };

    // Fallback demo data 
    const FALLBACK = {
      students: [
        { id:1, firstName:'KarolÃ­na', lastName:'BayerovÃ¡', fullName:'KarolÃ­na BayerovÃ¡', nickname:'KarolÃ­nka', instrument:'kytara', grade:3, motivation:2, birthDate:'2015-11-28', avatarUrl: 'https://i.pravatar.cc/150?u=a042581f4e29026704d'},
        { id:2, firstName:'AntonÃ­n', lastName:'BechyÅˆa', fullName:'AntonÃ­n BechyÅˆa', nickname:'TonÃ­k', instrument:'kytara', grade:4, motivation:1, birthDate:'2014-10-02', avatarUrl: 'https://i.pravatar.cc/150?u=a042581f4e29026704e' },
        { id:3, firstName:'Filip', lastName:'ÄŒervenka', fullName:'Filip ÄŒervenka', nickname:'FilÃ­pek', instrument:'klarinet', grade:4, motivation:3, birthDate:'2015-04-05', avatarUrl: 'https://i.pravatar.cc/150?u=a042581f4e29026704f' },
        { id:4, firstName:'Marie', lastName:'NovÃ¡', fullName:'Marie NovÃ¡', nickname:'MariÄka', instrument:'zobcovÃ¡ flÃ©tna', grade:2, motivation:4, birthDate:'2016-03-15', avatarUrl: '' },
        { id:5, firstName:'TomÃ¡Å¡', lastName:'Svoboda', fullName:'TomÃ¡Å¡ Svoboda', nickname:'Tom', instrument:'saxofon', grade:3, motivation:5, birthDate:'2015-07-20', avatarUrl: 'https://i.pravatar.cc/150?u=a042581f4e29026704g' }
      ],
      tasks: [
        { id:1, studentName:'AntonÃ­n BechyÅˆa', title:'HrÃ¡t sprÃ¡vnÃ© noty', composition:'Coleman - IrskÃ¡', status:'â³ CviÄÃ­me', date:'2025-09-19', points:6, note:'ZamÄ›Å™it se na posuvky' },
        { id:2, studentName:'AntonÃ­n BechyÅˆa', title:'DotÃ¡hnout drÅ¾enÃ­ nÃ¡stroje', composition:'Bach - ChorÃ¡l Ä. 1', status:'ğŸš€ SkvÄ›lÃ½ pokrok!', date:'2025-09-20', points:9, note:'' },
        { id:3, studentName:'KarolÃ­na BayerovÃ¡', title:'CviÄit stupnice', composition:'', status:'â³ CviÄÃ­me', date:'2025-09-21', points:7, note:'C dur, G dur' },
        { id:4, studentName:'Filip ÄŒervenka', title:'RytmickÃ¡ cviÄenÃ­', composition:'Etuda Ä. 5', status:'âœ… ZvlÃ¡dnuto', date:'2025-09-18', points:10, note:'VÃ½bornÄ›!' },
        { id:5, studentName:'Marie NovÃ¡', title:'ZÃ¡kladnÃ­ technika', composition:'', status:'â³ CviÄÃ­me', date:'2025-09-22', points:5, note:'ProcviÄit fingering' }
      ],
      awards: [
        { id:1, studentName:'AntonÃ­n BechyÅˆa', title:'RytmickÃ½ mistr', description:'Za zvlÃ¡dnutÃ­ sloÅ¾itÃ©ho rytmu', imageUrl:'https://i.imgur.com/example1.jpg' },
        { id:2, studentName:'KarolÃ­na BayerovÃ¡', title:'PilnÃ½ student', description:'Za pravidelnÃ© cviÄenÃ­', imageUrl:'' },
        { id:3, studentName:'Filip ÄŒervenka', title:'TechnickÃ½ pokrok', description:'Za vÃ½raznÃ© zlepÅ¡enÃ­ techniky', imageUrl:'' }
      ]
    };

    // GlobÃ¡lnÃ­ stav aplikace
    let appState = {
      students: [], tasks: [], awards: [], 
      currentView: 'dashboard', currentStudent: null,
      isAdmin: false
    };

    // PomocnÃ© funkce
    const el = id => document.getElementById(id);
    const age = d => { const b=new Date(d), t=new Date(); let a=t.getFullYear()-b.getFullYear(); const m=t.getMonth()-b.getMonth(); if(m<0||(m===0&&t.getDate()<b.getDate())) a--; return a; };
    const initials = (f,l) => ((f?.[0]||'') + (l?.[0]||'')).toUpperCase();
    
    // KlÃ­ÄovÃ¡ oprava: logickÃ¡ inverze motivace
    const motClass = m => m <= 2 ? 'mot-high' : (m === 3 ? 'mot-mid' : 'mot-low');
    const motText = m => m <= 2 ? 'VysokÃ¡ motivace' : (m === 3 ? 'StÅ™ednÃ­ motivace' : 'Krize motivace');
    
    const formatDate = d => new Date(d).toLocaleDateString('cs-CZ');

    // KLÃÄŒOVÃ OPRAVA: JSONP fetch
    async function fetchAPI() {
      const p = new URLSearchParams(location.search);
      const admin = p.get('admin');
      const token = p.get('token');

      let url = CONFIG.apiBaseUrl + '?format=json';
      if (admin) url += '&admin=' + encodeURIComponent(admin);
      else if (token) url += '&token=' + encodeURIComponent(token);

      const cb = 'jsonp_cb_' + Date.now();
      url += '&callback=' + cb;

      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        window[cb] = (payload) => {
          try { resolve(payload); }
          finally {
            delete window[cb];
            s.remove();
          }
        };
        s.onerror = () => {
          delete window[cb];
          s.remove();
          reject(new Error('JSONP failed'));
        };
        s.src = url;
        document.head.appendChild(s);

        setTimeout(() => {
          if (window[cb]) {
            delete window[cb];
            s.remove();
            reject(new Error('JSONP timeout'));
          }
        }, CONFIG.timeoutMs || 8000);
      });
    }

    // Navigation
    function showView(viewName) {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');
      
      document.getElementById('dashboard-view').style.display = viewName === 'dashboard' ? 'block' : 'none';
      document.getElementById('statistics-view').style.display = viewName === 'statistics' ? 'block' : 'none';
      document.getElementById('detail-view').style.display = 'none';
      
      if (viewName === 'statistics') {
        renderStatistics();
      }
      appState.currentView = viewName;
    }

    function showDashboard() {
      showView('dashboard');
      // zobrazit admin rozhranÃ­
      document.getElementById('student-only-sections').style.display = 'block';
      document.getElementById('admin-only-sections').style.display = 'block';
      renderGrid(appState.students);
    }
    
    function showStudentDetail(student) {
      appState.currentStudent = student;
      document.getElementById('detail-view').style.display = 'block';
      document.getElementById('dashboard-view').style.display = 'none';
      document.getElementById('statistics-view').style.display = 'none';

      // PÅ¯vodnÃ­ logika se zachovÃ¡, ale pro studenta se zobrazÃ­ pouze jeho data
      if (appState.isAdmin) {
          document.getElementById('student-only-sections').style.display = 'none';
          document.getElementById('admin-only-sections').style.display = 'block';
      } else {
          document.getElementById('student-only-sections').style.display = 'block';
          document.getElementById('admin-only-sections').style.display = 'none';
      }

      renderStudentDetail(student);
    }


    // Stats rendering
    function renderStats() {
      const completedTasks = appState.tasks.filter(t => t.status === 'âœ… ZvlÃ¡dnuto');
      
      el('totalStudents').textContent = appState.students.length;
      el('activeTasks').textContent = appState.tasks.filter(t => t.status !== 'âœ… ZvlÃ¡dnuto').length;
      el('completedTasks').textContent = completedTasks.length;
      el('totalAwards').textContent = appState.awards.length;
    }

    function renderStatistics() {
      const avgPoints = appState.tasks.length > 0 
        ? (appState.tasks.reduce((sum, t) => sum + (t.points || 0), 0) / appState.tasks.length).toFixed(1)
        : 0;
      
      const instrumentCounts = {};
      appState.students.forEach(s => {
        instrumentCounts[s.instrument] = (instrumentCounts[s.instrument] || 0) + 1;
      });
      const topInstrument = Object.keys(instrumentCounts).sort((a,b) => instrumentCounts[b] - instrumentCounts[a])[0] || '-';
      
      const successRate = appState.tasks.length > 0 
        ? Math.round((appState.tasks.filter(t => t.status === 'âœ… ZvlÃ¡dnuto').length / appState.tasks.length) * 100)
        : 0;

      el('avgPoints').textContent = avgPoints;
      el('topInstrument').textContent = topInstrument;
      el('successRate').textContent = successRate + '%';

      renderInstrumentChart(instrumentCounts);
      renderGradeChart();
    }

    function renderInstrumentChart(data) {
      const container = el('instrumentChart');
      const maxVal = Math.max(...Object.values(data));
      
      container.innerHTML = Object.entries(data).map(([instrument, count]) => {
        const height = maxVal > 0 ? (count / maxVal) * 150 : 0;
        return `
          <div style="display:inline-block; margin:0 8px; text-align:center;">
            <div class="chart-bar" style="width:40px; height:${height}px; margin-bottom:8px;"></div>
            <div class="chart-label">${instrument}</div>
            <div class="chart-label">${count}</div>
          </div>
        `;
      }).join('');
    }

    function renderGradeChart() {
      const gradeCounts = {};
      appState.students.forEach(s => {
        gradeCounts[s.grade] = (gradeCounts[s.grade] || 0) + 1;
      });
      
      const container = el('gradeChart');
      const maxVal = Math.max(...Object.values(gradeCounts));
      
      container.innerHTML = Object.entries(gradeCounts).sort().map(([grade, count]) => {
        const height = maxVal > 0 ? (count / maxVal) * 150 : 0;
        return `
          <div style="display:inline-block; margin:0 8px; text-align:center;">
            <div class="chart-bar" style="width:40px; height:${height}px; margin-bottom:8px;"></div>
            <div class="chart-label">${grade}. roÄnÃ­k</div>
            <div class="chart-label">${count}</div>
          </div>
        `;
      }).join('');
    }

    // Grid rendering
    function renderGrid(students) {
      const grid = el('grid');
      if (!grid) return;
      
      if (!students.length) {
        grid.innerHTML = '<div class="card" style="grid-column:1/-1;text-align:center;color:var(--muted);">Å½Ã¡dnÃ­ Å¾Ã¡ci nevyhovujÃ­ filtrÅ¯m</div>';
        return;
      }

      grid.innerHTML = students.map(s => {
        const studentTasks = appState.tasks.filter(t => t.studentName === s.fullName);
        const avgPoints = studentTasks.length > 0 ? (studentTasks.reduce((sum, t) => sum + (t.points || 0), 0) / studentTasks.length).toFixed(1) : '0.0';
        
        // KLÃÄŒOVÃ OPRAVA: Avatar z url
        const avatarContent = s.avatarUrl ? `<img src="${s.avatarUrl}" alt="${s.fullName}">` : initials(s.firstName, s.lastName);

        return `
          <div class="card fade-in" onclick="showStudentDetail(${JSON.stringify(s).replace(/"/g, '&quot;')})">
            <div class="row">
              <div class="avatar">${avatarContent}</div>
              <div style="flex:1;">
                <div class="name">${s.nickname || s.firstName}</div>
                <div class="muted">${s.instrument} â€¢ ${s.grade}. roÄnÃ­k â€¢ ${age(s.birthDate)} let</div>
              </div>
            </div>
            <div class="badges">
              <div class="badge ${motClass(s.motivation||3)}">${motText(s.motivation||3)}</div>
              <div class="badge">â­ ${avgPoints} bodÅ¯</div>
              <div class="badge">ğŸ“ ${studentTasks.length} ÃºkolÅ¯</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Student detail rendering
    function renderStudentDetail(student) {
      // KLÃÄŒOVÃ OPRAVA: filtrace ÃºkolÅ¯ podle 'CelÃ© jmÃ©no'
      const studentTasks = appState.tasks.filter(t => t.studentName === student.fullName);
      const studentAwards = appState.awards.filter(a => a.studentName === student.fullName);

      // Header
      // KLÃÄŒOVÃ OPRAVA: Avatar z url a celÃ© jmÃ©no
      const avatarContent = student.avatarUrl ? `<img src="${student.avatarUrl}" alt="${student.fullName}">` : initials(student.firstName, student.lastName);
      el('detailAvatar').innerHTML = avatarContent;
      el('detailName').textContent = student.fullName;
      el('detailBasicInfo').textContent = `${student.instrument} â€¢ ${student.grade}. roÄnÃ­k â€¢ ${age(student.birthDate)} let`;

      // Admin zobrazenÃ­ detailu
      if (appState.isAdmin) {
          const totalPoints = studentTasks.reduce((sum, t) => sum + (t.points || 0), 0);
          const ongoingCompositions = studentTasks.filter(t => t.composition && t.status !== 'âœ… ZvlÃ¡dnuto').length;
          const completedCompositions = studentTasks.filter(t => t.composition && t.status === 'âœ… ZvlÃ¡dnuto').length;
          
          el('scorePoints').textContent = totalPoints;
          el('scoreOngoingCompositions').textContent = ongoingCompositions;
          el('scoreCompletedCompositions').textContent = completedCompositions;

          const tasksCompositions = studentTasks.filter(t => t.composition);
          const tasksNoCompositions = studentTasks.filter(t => !t.composition && t.status !== 'âœ… ZvlÃ¡dnuto');
          const tasksCompleted = studentTasks.filter(t => t.status === 'âœ… ZvlÃ¡dnuto');

          el('tasks-compositions').innerHTML = tasksCompositions.length > 0 ? tasksCompositions.map(task => `
              <div class="task-item fade-in">
                  <div class="task-header">
                      <div class="task-title">${task.title}</div>
                      <div class="task-points">${task.points || 0} b</div>
                  </div>
                  <div class="muted">ğŸµ ${task.composition}</div>
                  <div class="task-status">${task.status}</div>
                  <div class="task-date">ğŸ“… ${formatDate(task.date)}</div>
                  ${task.note ? `<div class="muted" style="margin-top:8px; font-style:italic;">"${task.note}"</div>` : ''}
              </div>
          `).join('') : '<div class="loading">ğŸ“ ZatÃ­m Å¾Ã¡dnÃ© skladby</div>';

          el('tasks-no-compositions').innerHTML = tasksNoCompositions.length > 0 ? tasksNoCompositions.map(task => `
              <div class="task-item fade-in">
                  <div class="task-header">
                      <div class="task-title">${task.title}</div>
                      <div class="task-points">${task.points || 0} b</div>
                  </div>
                  <div class="task-status">${task.status}</div>
                  <div class="task-date">ğŸ“… ${formatDate(task.date)}</div>
                  ${task.note ? `<div class="muted" style="margin-top:8px; font-style:italic;">"${task.note}"</div>` : ''}
              </div>
          `).join('') : '<div class="loading">âœ… VÅ¡e hotovo!</div>';

          el('tasks-completed').innerHTML = tasksCompleted.length > 0 ? tasksCompleted.map(task => `
              <div class="task-item fade-in">
                  <div class="task-header">
                      <div class="task-title">${task.title}</div>
                      <div class="task-points">${task.points || 0} b</div>
                  </div>
                  <div class="task-status">${task.status}</div>
                  <div class="task-date">ğŸ“… ${formatDate(task.date)}</div>
              </div>
          `).join('') : '<div class="loading">ğŸ“ Å½Ã¡dnÃ© dokonÄenÃ© Ãºkoly</div>';
          
          el('my-awards').innerHTML = studentAwards.length > 0 ? studentAwards.map(award => `
              <div class="award-item fade-in">
                  <div style="display:flex; gap:12px; align-items:start;">
                      ${award.imageUrl ? `<img src="${award.imageUrl}" style="width:48px; height:48px; border-radius:8px; object-fit:cover;">` : '<div style="width:48px; height:48px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ†</div>'}
                      <div style="flex:1;">
                          <div style="font-weight:600; margin-bottom:4px;">${award.title}</div>
                          <div class="muted">${award.description}</div>
                      </div>
                  </div>
              </div>
          `).join('') : '<div class="loading">ğŸ† ZatÃ­m Å¾Ã¡dnÃ¡ ocenÄ›nÃ­</div>';

      } else {
        // PÅ¯vodnÃ­ zobrazenÃ­ pro studenta, s upravenou logikou
        el('detailTasks').innerHTML = studentTasks.length > 0 
          ? studentTasks.sort((a,b) => new Date(b.date) - new Date(a.date)).map(task => `
              <div class="task-item fade-in">
                <div class="task-header">
                  <div class="task-title">${task.title}</div>
                  <div class="task-points">${task.points || 0} b</div>
                </div>
                ${task.composition ? `<div class="muted">ğŸµ ${task.composition}</div>` : ''}
                <div class="task-status">${task.status}</div>
                <div class="task-date">ğŸ“… ${formatDate(task.date)}</div>
                ${task.note ? `<div class="muted" style="margin-top:8px; font-style:italic;">"${task.note}"</div>` : ''}
              </div>
            `).join('')
          : '<div class="loading">ğŸ“ ZatÃ­m Å¾Ã¡dnÃ© Ãºkoly</div>';

        el('detailAwards').innerHTML = studentAwards.length > 0
          ? studentAwards.map(award => `
              <div class="award-item fade-in">
                <div style="display:flex; gap:12px; align-items:start;">
                  ${award.imageUrl ? `<img src="${award.imageUrl}" style="width:48px; height:48px; border-radius:8px; object-fit:cover;">` : '<div style="width:48px; height:48px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ†</div>'}
                  <div style="flex:1;">
                    <div style="font-weight:600; margin-bottom:4px;">${award.title}</div>
                    <div class="muted">${award.description}</div>
                  </div>
                </div>
              </div>
            `).join('')
          : '<div class="loading">ğŸ† ZatÃ­m Å¾Ã¡dnÃ¡ ocenÄ›nÃ­</div>';
      }
    }

    // Filtering
    function applyFilters() {
      const i = el('fInstrument').value;
      const g = el('fGrade').value;
      const m = el('fMot').value;
      
      let students = [...appState.students];
      if (i) students = students.filter(s => (s.instrument||'') === i);
      if (g) students = students.filter(s => String(s.grade||'') === g);
      if (m) {
        // KLÃÄŒOVÃ OPRAVA: filtry motivace odpovÃ­dajÃ­ novÃ© logice
        if (m==='high') students = students.filter(s => (s.motivation||0) <= 2);
        if (m==='mid') students = students.filter(s => (s.motivation||0) === 3);
        if (m==='low') students = students.filter(s => (s.motivation||0) >= 4);
      }
      
      renderGrid(students);
    }

    // Modals
    function showModal(id) {
      el(id).classList.add('show');
      if (id === 'addTaskModal' || id === 'addAwardModal') {
        populateStudentSelects();
      }
    }

    function hideModal(id) {
      el(id).classList.remove('show');
    }

    function showAddTaskModal() {
      if (appState.currentStudent) {
        showModal('addTaskModal');
        el('taskStudent').value = appState.currentStudent.fullName;
      } else {
        showModal('addTaskModal');
      }
    }

    function showAddAwardModal() {
      if (appState.currentStudent) {
        showModal('addAwardModal');
        el('awardStudent').value = appState.currentStudent.fullName;
      } else {
        showModal('addAwardModal');
      }
    }

    function populateStudentSelects() {
      const taskSelect = el('taskStudent');
      const awardSelect = el('awardStudent');
      
      const options = appState.students.map(s => 
        `<option value="${s.fullName}">${s.fullName}</option>`
      ).join('');
      
      taskSelect.innerHTML = '<option value="">Vyberte Å¾Ã¡ka...</option>' + options;
      awardSelect.innerHTML = '<option value="">Vyberte Å¾Ã¡ka...</option>' + options;
    }

    // Form handling
    function handleAddTask(e) {
      e.preventDefault();
      
      const newTask = {
        id: Math.max(...appState.tasks.map(t => t.id), 0) + 1,
        studentName: el('taskStudent').value,
        title: el('taskTitle').value,
        composition: el('taskComposition').value,
        note: el('taskNote').value,
        status: el('taskStatus').value,
        points: parseInt(el('taskPoints').value) || 5,
        date: new Date().toISOString().split('T')[0]
      };
      
      appState.tasks.push(newTask);
      hideModal('addTaskModal');
      el('addTaskForm').reset();
      
      // Refresh current view
      if (appState.currentStudent) {
        renderStudentDetail(appState.currentStudent);
      }
      renderStats();
      
      // TODO: Send to API
      console.log('New task:', newTask);
    }

    function handleAddAward(e) {
      e.preventDefault();
      
      const newAward = {
        id: Math.max(...appState.awards.map(a => a.id), 0) + 1,
        studentName: el('awardStudent').value,
        title: el('awardTitle').value,
        description: el('awardDescription').value,
        imageUrl: el('awardImageUrl').value
      };
      
      appState.awards.push(newAward);
      hideModal('addAwardModal');
      el('addAwardForm').reset();
      
      // Refresh current view
      if (appState.currentStudent) {
        renderStudentDetail(appState.currentStudent);
      }
      renderStats();
      
      // TODO: Send to API
      console.log('New award:', newAward);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', async () => {
      // Navigation
      document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showView(btn.dataset.view));
      });

      // Filters
      ['fInstrument','fGrade','fMot'].forEach(id => {
        const select = el(id);
        if (select) select.addEventListener('change', applyFilters);
      });

      // Forms
      el('addTaskForm')?.addEventListener('submit', handleAddTask);
      el('addAwardForm')?.addEventListener('submit', handleAddAward);

      // Modal close on outside click
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          hideModal(e.target.id);
        }
      });
      
      const params = new URLSearchParams(location.search);
      const token = params.get('token');
      const admin = params.get('admin');

      // Load data
      try {
        const payload = await fetchAPI();
        if (payload?.success) {
          appState.isAdmin = (payload.userType === 'admin');
          const data = payload.data || payload.studentData;
          
          if (appState.isAdmin) {
            appState.students = (data.zaci || []).map(z => ({
              id: z.id || z.ID || Math.random(),
              firstName: z.firstName || z['JmÃ©no'] || '',
              lastName: z.lastName || z['PÅ™Ã­jmenÃ­'] || '',
              fullName: z['CelÃ© jmÃ©no'] || '', // KLÃÄŒOVÃ OPRAVA: novÃ© pole pro celÃ© jmÃ©no
              nickname: z.nickname || z['oslovenÃ­ 1. pÃ¡d'] || z['OslovenÃ­'] || z['JmÃ©no'] || '',
              instrument: z.instrument || z['PÅ™edmÄ›t'] || '',
              grade: Number(z.grade || z['RoÄnÃ­k'] || 0),
              motivation: Number(z.motivation || z['BavÃ­/krize'] || 3),
              birthDate: z.birthDate || z['Datum narozenÃ­'] || '2015-01-01',
              avatarUrl: z['avatar'] || z['url'] || '' // KLÃÄŒOVÃ OPRAVA: novÃ½ klÃ­Ä pro url
            }));
            appState.tasks = (data.denik || []).map(d => ({
              id: d.id || Math.random(),
              studentName: d['Å½Ã¡k'] || '',
              title: d.title || d['NÃ¡zev Ãºkolu'] || '',
              composition: d.composition || d['Skladba'] || '',
              status: d.status || d['Stav Ãºkolu'] || '',
              date: d.date || d['Datum'] || new Date().toISOString().split('T')[0],
              points: Number(d.points || d['Body'] || 0),
              note: d.note || d['PoznÃ¡mka'] || ''
            }));
            appState.awards = (data.oceneni || []).map(a => ({
              id: a.id || Math.random(),
              studentName: a['Å½Ã¡k'] || '',
              title: a.title || a['NÃ¡zev ocenÄ›nÃ­'] || '',
              description: a.description || a['Popis'] || '',
              imageUrl: a.imageUrl || a['url'] || a['url '] || ''
            }));
            
            showDashboard();

          } else if (payload.userType === 'student' && payload.studentData) {
            const studentData = payload.studentData;
            const s = studentData.student;
            appState.students = [{
              id: s.id || s.ID || Math.random(),
              firstName: s.firstName || s['JmÃ©no'] || '',
              lastName: s.lastName || s['PÅ™Ã­jmenÃ­'] || '',
              fullName: s['CelÃ© jmÃ©no'] || '', // KLÃÄŒOVÃ OPRAVA
              nickname: s.nickname || s['oslovenÃ­ 1. pÃ¡d'] || s['OslovenÃ­'] || s['JmÃ©no'] || '',
              instrument: s.instrument || s['PÅ™edmÄ›t'] || '',
              grade: Number(s.grade || s['RoÄnÃ­k'] || 0),
              motivation: Number(s.motivation || s['BavÃ­/krize'] || 3),
              birthDate: s.birthDate || s['Datum narozenÃ­'] || '2015-01-01',
              avatarUrl: s['avatar'] || s['url'] || '' // KLÃÄŒOVÃ OPRAVA
            }];
            appState.tasks = (studentData.denik || []).map(d => ({
              id: d.id || Math.random(),
              studentName: d['Å½Ã¡k'] || '',
              title: d.title || d['NÃ¡zev Ãºkolu'] || '',
              composition: d.composition || d['Skladba'] || '',
              status: d.status || d['Stav Ãºkolu'] || '',
              date: d.date || d['Datum'] || new Date().toISOString().split('T')[0],
              points: Number(d.points || d['Body'] || 0),
              note: d.note || d['PoznÃ¡mka'] || ''
            }));
            appState.awards = (studentData.oceneni || []).map(a => ({
              id: a.id || Math.random(),
              studentName: a['Å½Ã¡k'] || '',
              title: a.title || a['NÃ¡zev ocenÄ›nÃ­'] || '',
              description: a.description || a['Popis'] || '',
              imageUrl: a.imageUrl || a['url'] || a['url '] || ''
            }));
            appState.currentStudent = appState.students[0];
            showStudentDetail(appState.currentStudent);
            
          } else {
            throw new Error('API returned no data');
          }
        } else {
          throw new Error('API returned no data');
        }
      } catch (e) {
        console.log('API failed, using fallback data:', e);
        appState.students = FALLBACK.students.map(s => ({
          ...s,
          fullName: s.firstName + ' ' + s.lastName,
          avatarUrl: s.avatarUrl || '' // Ensure avatarUrl exists
        }));
        appState.tasks = [...FALLBACK.tasks];
        appState.awards = [...FALLBACK.awards];
        appState.isAdmin = true;
        showDashboard();
      }
      
      renderStats();
      applyFilters(); // mÃ­sto renderGrid(appState.students) - aby se respektovaly filtry
      
      // Skryjeme tlaÄÃ­tka pro pÅ™idÃ¡nÃ­ ÃºkolÅ¯ a ocenÄ›nÃ­ pro studenta
      if (!appState.isAdmin) {
          document.querySelectorAll('.btn-primary').forEach(btn => btn.style.display = 'none');
          document.querySelectorAll('.controls').forEach(ctrl => ctrl.style.display = 'none');
          document.querySelectorAll('.nav-btn[data-view="statistics"]').forEach(btn => btn.style.display = 'none');
      }
    });
  </script>
</body>
</html>
